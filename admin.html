<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel Admin | MCME</title>

  <link rel="stylesheet" href="assets/css/reset.css" />
  <link rel="stylesheet" href="assets/css/variables.css" />
  <link rel="stylesheet" href="assets/css/base.css" />
  <link rel="stylesheet" href="assets/css/layout.css" />
  <link rel="stylesheet" href="assets/css/components.css" />
</head>

<body>

<header id="app-header">
  <div class="header-left">
    <img
      src="assets/images/mcme-logo.svg"
      alt="MCME"
      class="app-logo"
    />
  </div>

  <div class="header-right">
    <strong>Administrador</strong>
    <button id="logoutBtn">Cerrar sesión</button>
  </div>
</header>

<main class="login-page">
  <section class="login-container" style="max-width:700px">

    <!-- ===================== -->
    <!-- USUARIOS PENDIENTES -->
    <!-- ===================== -->
    <h1>Usuarios pendientes</h1>
    <ul id="users" style="margin-top:1.5rem; list-style:none; padding:0"></ul>

    <!-- ===================== -->
    <!-- USUARIOS APROBADOS -->
    <!-- ===================== -->
    <h1 style="margin-top:2rem">Usuarios aprobados</h1>
    <ul id="approvedUsers" style="margin-top:1.5rem; list-style:none; padding:0"></ul>

    <!-- ===================== -->
    <!-- USUARIOS SUSPENDIDOS -->
    <!-- ===================== -->
    <h1 style="margin-top:2rem">Usuarios suspendidos</h1>
    <ul id="suspendedUsers" style="margin-top:1.5rem; list-style:none; padding:0"></ul>

  </section>
</main>

<script>
const ADMIN_EMAIL = "sorcrar@gmail.com";
const API = "https://mcme-backend.onrender.com/api/admin";

// ==========================
// SEGURIDAD BÁSICA
// ==========================
const session = JSON.parse(localStorage.getItem("user"));
if (!session || session.email !== ADMIN_EMAIL) {
  window.location.href = "login.html";
}

// cerrar sesión
document.getElementById("logoutBtn").onclick = () => {
  localStorage.removeItem("user");
  window.location.href = "login.html";
};

// ==========================
// USUARIOS PENDIENTES
// ==========================
async function loadUsers() {
  const res = await fetch(`${API}/pending`, {
    headers: { "x-admin-email": ADMIN_EMAIL }
  });

  const users = await res.json();
  const ul = document.getElementById("users");
  ul.innerHTML = "";

  if (users.length === 0) {
    ul.innerHTML = "<p>No hay usuarios pendientes.</p>";
    return;
  }

  users.forEach(u => {
    const li = document.createElement("li");
    li.style.marginBottom = "1rem";

    li.innerHTML = `
      <div class="book-card">
        <strong>${u.name}</strong>
        <p>${u.email}</p>
        <div style="margin-top:.8rem">
          <button onclick="approve('${u.email}')">Aprobar</button>
          <button onclick="reject('${u.email}')" style="margin-left:.5rem;background:#ccc">
            Rechazar
          </button>
        </div>
      </div>
    `;
    ul.appendChild(li);
  });
}

async function approve(email) {
  await fetch(`${API}/approve`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-email": ADMIN_EMAIL
    },
    body: JSON.stringify({ email })
  });

  loadUsers();
  loadApprovedUsers();
}

// ==========================
// RECHAZAR
// ==========================
async function reject(email) {
  await fetch(`${API}/reject`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-email": ADMIN_EMAIL
    },
    body: JSON.stringify({ email })
  });

  loadUsers();
}

// ==========================
// USUARIOS APROBADOS
// ==========================
async function loadApprovedUsers() {
  const res = await fetch(`${API}/approved`, {
    headers: { "x-admin-email": ADMIN_EMAIL }
  });

  const users = await res.json();
  const ul = document.getElementById("approvedUsers");
  ul.innerHTML = "";

  if (users.length === 0) {
    ul.innerHTML = "<p>No hay usuarios aprobados.</p>";
    return;
  }

  users.forEach(u => {
    const li = document.createElement("li");
    li.style.marginBottom = "1rem";

    li.innerHTML = `
      <div class="book-card">
        <strong>${u.name}</strong>
        <p>${u.email}</p>
        <button
          onclick="revoke('${u.email}')"
          style="margin-top:.5rem;background:#e74c3c;color:#fff">
          Quitar acceso
        </button>
      </div>
    `;
    ul.appendChild(li);
  });
}

async function revoke(email) {
  await fetch(`${API}/revoke`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-email": ADMIN_EMAIL
    },
    body: JSON.stringify({ email })
  });

  loadApprovedUsers();
  loadSuspendedUsers();
}

// ==========================
// USUARIOS SUSPENDIDOS
// ==========================
async function loadSuspendedUsers() {
  const res = await fetch(`${API}/suspended`, {
    headers: { "x-admin-email": ADMIN_EMAIL }
  });

  const users = await res.json();
  const ul = document.getElementById("suspendedUsers");
  ul.innerHTML = "";

  if (users.length === 0) {
    ul.innerHTML = "<p>No hay usuarios suspendidos.</p>";
    return;
  }

  users.forEach(u => {
    const li = document.createElement("li");
    li.style.marginBottom = "1rem";

    li.innerHTML = `
      <div class="book-card">
        <strong>${u.name}</strong>
        <p>${u.email}</p>
        <button
          onclick="reactivate('${u.email}')"
          style="margin-top:.5rem;background:#2ecc71;color:#fff">
          Reactivar acceso
        </button>
      </div>
    `;
    ul.appendChild(li);
  });
}

async function reactivate(email) {
  await fetch(`${API}/reactivate`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-email": ADMIN_EMAIL
    },
    body: JSON.stringify({ email })
  });

  loadSuspendedUsers();
  loadApprovedUsers();
}

// ==========================
// INICIO
// ==========================
loadUsers();
loadApprovedUsers();
loadSuspendedUsers();
</script>

</body>
</html>
